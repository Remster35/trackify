// ====== CONFIG – put your Supabase values here ======
const SUPABASE_URL = "YOUR_SUPABASE_URL";
const SUPABASE_ANON_KEY = "YOUR_SUPABASE_ANON_KEY";

const { createClient } = supabase;
const db = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

let currentUser = null;
let currentTrackerId = null;

// DOM ELEMENTS
const authSection = document.getElementById("auth");
const dashboardSection = document.getElementById("dashboard");
const userEmailSpan = document.getElementById("user-email");

const tabLogin = document.getElementById("tab-login");
const tabSignup = document.getElementById("tab-signup");
const loginForm = document.getElementById("login-form");
const signupForm = document.getElementById("signup-form");
const loginMsg = document.getElementById("login-msg");
const signupMsg = document.getElementById("signup-msg");

const heroGetStarted = document.getElementById("hero-get-started");
const logoutBtn = document.getElementById("logout-btn");

const trackerForm = document.getElementById("tracker-form");
const trackerNameInput = document.getElementById("tracker-name");
const trackerTypeInput = document.getElementById("tracker-type");
const trackerFormMsg = document.getElementById("tracker-form-msg");

const trackerList = document.getElementById("tracker-list");
const trackerListEmpty = document.getElementById("tracker-list-empty");

const entriesTitle = document.getElementById("entries-title");
const entryForm = document.getElementById("entry-form");
const entryDateInput = document.getElementById("entry-date");
const entryValueInput = document.getElementById("entry-value");
const entryNoteInput = document.getElementById("entry-note");
const entryFormMsg = document.getElementById("entry-form-msg");
const entryList = document.getElementById("entry-list");

const proLink = document.getElementById("pro-link");
const pricingProBtn = document.getElementById("pricing-pro-btn");

// ====== BASIC NAV HELPERS ======
heroGetStarted.addEventListener("click", () => {
  document.getElementById("auth").scrollIntoView({ behavior: "smooth" });
});

// Make Pro buttons show a message until you add Stripe
const handleProClick = (e) => {
  e.preventDefault();
  alert("To make money, create a Stripe payment link and paste it into the Go Pro buttons.");
};
proLink.addEventListener("click", handleProClick);
pricingProBtn.addEventListener("click", handleProClick);

// ====== AUTH TABS ======
tabLogin.addEventListener("click", () => {
  tabLogin.classList.add("active");
  tabSignup.classList.remove("active");
  loginForm.classList.remove("hidden");
  signupForm.classList.add("hidden");
});

tabSignup.addEventListener("click", () => {
  tabSignup.classList.add("active");
  tabLogin.classList.remove("active");
  signupForm.classList.remove("hidden");
  loginForm.classList.add("hidden");
});

// ====== SIGN UP ======
signupForm.addEventListener("submit", async (e) => {
  e.preventDefault();
  signupMsg.textContent = "";
  const email = document.getElementById("signup-email").value.trim();
  const password = document.getElementById("signup-password").value.trim();

  signupMsg.textContent = "Signing up...";
  const { data, error } = await db.auth.signUp({ email, password });
  if (error) {
    signupMsg.textContent = error.message;
  } else {
    signupMsg.textContent = "Check your email to confirm, then log in.";
  }
});

// ====== LOG IN ======
loginForm.addEventListener("submit", async (e) => {
  e.preventDefault();
  loginMsg.textContent = "";
  const email = document.getElementById("login-email").value.trim();
  const password = document.getElementById("login-password").value.trim();

  loginMsg.textContent = "Logging in...";
  const { data, error } = await db.auth.signInWithPassword({ email, password });
  if (error) {
    loginMsg.textContent = error.message;
  } else {
    loginMsg.textContent = "";
    await loadSession();
  }
});

// ====== LOG OUT ======
logoutBtn.addEventListener("click", async () => {
  await db.auth.signOut();
  currentUser = null;
  showAuth();
});

// ====== SESSION HANDLING ======
async function loadSession() {
  const { data } = await db.auth.getUser();
  if (data.user) {
    currentUser = data.user;
    userEmailSpan.textContent = currentUser.email;
    showDashboard();
    await loadTrackers();
  } else {
    showAuth();
  }
}

function showDashboard() {
  authSection.classList.add("hidden");
  dashboardSection.classList.remove("hidden");
}

function showAuth() {
  authSection.classList.remove("hidden");
  dashboardSection.classList.add("hidden");
}

// ====== TRACKERS ======
trackerForm.addEventListener("submit", async (e) => {
  e.preventDefault();
  trackerFormMsg.textContent = "";

  if (!currentUser) {
    trackerFormMsg.textContent = "You must be logged in.";
    return;
  }

  const name = trackerNameInput.value.trim();
  const type = trackerTypeInput.value.trim();

  if (!name || !type) {
    trackerFormMsg.textContent = "Please fill in all fields.";
    return;
  }

  trackerFormMsg.textContent = "Saving...";
  const { error } = await db.from("trackers").insert({
    user_id: currentUser.id,
    name,
    type
  });

  if (error) {
    trackerFormMsg.textContent = error.message;
  } else {
    trackerFormMsg.textContent = "Tracker added.";
    trackerNameInput.value = "";
    trackerTypeInput.value = "";
    await loadTrackers();
  }
});

async function loadTrackers() {
  if (!currentUser) return;

  const { data, error } = await db
    .from("trackers")
    .select("id, name, type, created_at")
    .eq("user_id", currentUser.id)
    .order("created_at", { ascending: true });

  trackerList.innerHTML = "";
  if (error) {
    trackerListEmpty.textContent = error.message;
    return;
  }

  if (!data || data.length === 0) {
    trackerListEmpty.classList.remove("hidden");
    return;
  }

  trackerListEmpty.classList.add("hidden");

  data.forEach((tracker) => {
    const li = document.createElement("li");
    const left = document.createElement("span");
    left.textContent = `${tracker.name} (${tracker.type})`;

    const btn = document.createElement("button");
    btn.className = "btn small outline";
    btn.textContent = "Open";
    btn.addEventListener("click", () => selectTracker(tracker));

    li.appendChild(left);
    li.appendChild(btn);
    trackerList.appendChild(li);
  });
}

async function selectTracker(tracker) {
  currentTrackerId = tracker.id;
  entriesTitle.textContent = `Entries – ${tracker.name}`;
  entryForm.classList.remove("hidden");
  entryFormMsg.textContent = "";
  await loadEntries();
}

// ====== ENTRIES ======
entryForm.addEventListener("submit", async (e) => {
  e.preventDefault();
  entryFormMsg.textContent = "";

  if (!currentTrackerId) {
    entryFormMsg.textContent = "Select a tracker first.";
    return;
  }

  const date = entryDateInput.value;
  const value = entryValueInput.value.trim();
  const note = entryNoteInput.value.trim();

  if (!date || !value) {
    entryFormMsg.textContent = "Date and value are required.";
    return;
  }

  entryFormMsg.textContent = "Saving...";
  const { error } = await db.from("entries").insert({
    tracker_id: currentTrackerId,
    date,
    value,
    note
  });

  if (error) {
    entryFormMsg.textContent = error.message;
  } else {
    entryFormMsg.textContent = "Entry added.";
    entryValueInput.value = "";
    entryNoteInput.value = "";
    await loadEntries();
  }
});

async function loadEntries() {
  entryList.innerHTML = "";

  if (!currentTrackerId) {
    return;
  }

  const { data, error } = await db
    .from("entries")
    .select("id, date, value, note, created_at")
    .eq("tracker_id", currentTrackerId)
    .order("date", { ascending: false });

  if (error) {
    entryFormMsg.textContent = error.message;
    return;
  }

  if (!data || data.length === 0) {
    const li = document.createElement("li");
    li.textContent = "No entries yet. Add one above.";
    entryList.appendChild(li);
    return;
  }

  data.forEach((entry) => {
    const li = document.createElement("li");
    const top = document.createElement("span");
    top.textContent = `${entry.date} – ${entry.value}`;

    const meta = document.createElement("span");
    meta.className = "meta";
    meta.textContent = entry.note ? entry.note : "";

    li.appendChild(top);
    li.appendChild(meta);
    entryList.appendChild(li);
  });
}

// ====== INIT ======
loadSession();

